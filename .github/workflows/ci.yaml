name: Release

on:
  workflow_dispatch:
  release:
    types: [created]

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      hashes: ${{ steps.hash.outputs.hashes }}
    steps:
      - name: Checkout code
        uses: actions/checkout@2541b1294d2704b0964813337f33b291d3f8596b # tag=v3
      - name: Setup bazelisk
        uses:  bazelbuild/setup-bazelisk@95c9bf48d0c570bb3e28e57108f3450cd67c1a44 # v2.0.0
        with:
          bazelisk-version: "1.11"
      - name: Build artifacts
        run: |
          bazel build //...
          cp bazel-bin/src/{fib,hello} .
      - name: Generate subject for provenance
        id: hash
        run: |
          set -euo pipefail
          sha256sum fib hello > checksums
          echo "::set-output name=hashes::$(cat checksums | base64 -w0)"
      - name: Upload artifacts (1/2)
        uses: actions/upload-artifact@3cea5372237819ed00197afe530f5a7ea3e805c8 # tag=v3.1.0
        with:
          name: fib
          path: fib
          if-no-files-found: error
          retention-days: 5
      - name: Upload artifacts (2/2)
        uses: actions/upload-artifact@3cea5372237819ed00197afe530f5a7ea3e805c8 # tag=v3.1.0
        with:
          name: hello
          path: hello
          if-no-files-found: error
          retention-days: 5

  provenance:
    needs: [build]
    permissions:
      actions: read
      id-token: write
      contents: read
    uses: slsa-framework/slsa-github-generator/.github/workflows/generator_generic_slsa3.yml@v1.1.1  # TODO(mihaimaruseac): pin by hash
    with:
      base64-subjects: "${{ needs.build.outputs.hashes }}"
      #upload-assets: true  # TODO(mihaimaruseac): Resolve with new release

  release:
    needs: [build, provenance]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Download fib artifact
        uses: actions/download-artifact@fb598a63ae348fa914e94cd0ff38f362e927b741 # tag=v2.1.0
        with:
          name: fib
      - name: Download hello artifact
        uses: actions/download-artifact@fb598a63ae348fa914e94cd0ff38f362e927b741 # tag=v2.1.0
        with:
          name: hello
      - name: Download attestation
        uses: actions/download-artifact@fb598a63ae348fa914e94cd0ff38f362e927b741 # tag=v2.1.0
        with:
          name: attestation.intoto.jsonl
      - name: Upload assets
        uses: softprops/action-gh-release@1e07f4398721186383de40550babbdf2b84acfc5 # v0.1.14
        with:
          files: |
            fib
            hello
            attestation.intoto.jsonl
